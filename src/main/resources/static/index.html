<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Analytics en Temps R√©el</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/smoothie/1.34.0/smoothie.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .controls { margin-bottom: 20px; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        canvas { border: 1px solid #ccc; margin-top: 20px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .connected { background-color: #d4edda; color: #155724; }
        .disconnected { background-color: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
<h1>Analytics Kafka Streams en Temps R√©el</h1>

<div class="controls">
    <button onclick="publishEvent('P1')">Publier P1</button>
    <button onclick="publishEvent('P2')">Publier P2</button>
    <button onclick="publishTestData()">Donn√©es de Test (10 events)</button>
    <button onclick="location.reload()">Actualiser</button>
</div>

<div id="status" class="status"></div>

<h2>Comptage des Pages (30 secondes)</h2>
<canvas id="chart2" width="800" height="400"></canvas>

<script>
    var index = -1;
    var colors = [
        { stroke: 'rgba(0, 255, 0, 1)', fill: 'rgba(0, 255, 0, 0.2)' },
        { stroke: 'rgba(255, 0, 0, 1)', fill: 'rgba(255, 0, 0, 0.2)' },
        { stroke: 'rgba(0, 0, 255, 1)', fill: 'rgba(0, 0, 255, 0.2)' },
        { stroke: 'rgba(255, 255, 0, 1)', fill: 'rgba(255, 255, 0, 0.2)' }
    ];

    function randomColor() {
        ++index;
        if (index >= colors.length) index = 0;
        return colors[index];
    }

    var pages = ["P1", "P2"];
    var courbe = [];

    // Configuration du graphique
    var smoothieChart = new SmoothieChart({
        tooltip: true,
        grid: { strokeStyle: 'rgb(125, 125, 125)', fillStyle: 'rgb(60, 60, 60)', lineWidth: 1, millisPerLine: 1000, verticalSections: 10 },
        labels: { fillStyle: 'rgb(255, 255, 255)' },
        maxValue: 50,
        minValue: 0
    });

    smoothieChart.streamTo(document.getElementById("chart2"), 1000);

    // Initialiser les s√©ries temporelles
    pages.forEach(function(page) {
        courbe[page] = new TimeSeries();
        var col = randomColor();
        smoothieChart.addTimeSeries(courbe[page], {
            strokeStyle: col.stroke,
            fillStyle: col.fill,
            lineWidth: 3
        });
    });

    // Connexion SSE
    var stockEventSource = new EventSource("/analytics");

    stockEventSource.onopen = function() {
        document.getElementById('status').className = 'status connected';
        document.getElementById('status').innerHTML = '‚úÖ Connect√© - En attente de donn√©es...';
    };

    stockEventSource.onmessage = function(event) {
        var data = JSON.parse(event.data);
        var timestamp = new Date().getTime();

        pages.forEach(function(page) {
            var value = data[page] || 0;
            courbe[page].append(timestamp, value);
        });

        // Afficher les derni√®res valeurs
        var statusText = 'üìä Derni√®res valeurs: ';
        pages.forEach(function(page) {
            statusText += page + '=' + (data[page] || 0) + ' ';
        });
        document.getElementById('status').innerHTML = statusText;
    };

    stockEventSource.onerror = function(event) {
        document.getElementById('status').className = 'status disconnected';
        document.getElementById('status').innerHTML = '‚ùå Erreur de connexion';
    };

    // Fonctions utilitaires
    function publishEvent(pageName) {
        fetch('/publish?name=' + pageName + '&topic=T3')
            .then(response => response.json())
            .then(data => {
                console.log('√âv√©nement publi√©:', data);
                alert('Page ' + pageName + ' publi√©e avec succ√®s!');
            });
    }

    function publishTestData() {
        fetch('/test')
            .then(response => response.text())
            .then(data => {
                console.log(data);
                alert(data);
            });
    }
</script>
</body>
</html>